<html>
<head>
    <link rel="stylesheet" data-name="vs/editor/editor.main"
          href="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.20.0/min/vs/editor/editor.main.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.20.0/min/vs/loader.min.js"></script>


    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
          integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
            integrity="sha256-4+XzXVhsDmqanXGHaHvgh1gMQKX40OUvDEBTu8JcmNs=" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>

    <style>
        #output {
            font-size: 1.5em;
        }
    </style>
</head>
<body>

<div class="container-fluid">
    <div class="row">
        <div class="col-sm">
            <div class="p-3">
                <div style="min-height: 500px;" id="editor"></div>
            </div>

            <div class="p-3">
                <button style="width: 100%;"
                        id="submitButton"
                        class="btn btn-primary"
                        type="button">Submit</button>
            </div>
        </div>
        <div class="col-sm">
            <nav class="navbar navbar-expand-lg navbar-light bg-light"><h2 class="mx-auto">Results</h2></nav>
            <div id="output"></div>
        </div>
    </div>
</div>


<script>
    require.config({paths: {'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.20.0/min/vs'}});
    window.MonacoEnvironment = {getWorkerUrl: () => proxy};
    let proxy = URL.createObjectURL(new Blob([`
    self.MonacoEnvironment = {
        baseUrl: 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.20.0/min'
    };
    importScripts('https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.20.0/min/vs/base/worker/workerMain.min.js');
`], {type: 'text/javascript'}));
    require(["vs/editor/editor.main"], function () {
        let editor = monaco.editor.create(document.getElementById('editor'), {
            value: `function x() {
  console.log("Hello world!");
}`,
            language: 'javascript',
            theme: 'vs-dark'
        });
        setSubmit(editor);
    });
</script>

<script>
    function dataToList(data = []) {
        const wrappers = {
            prefix: '<li class="list-group-item">',
            suffix: '</li>'
        };
        if (!Array.isArray(data)) {
            if (typeof data !== 'object') {
                return `<span class="badge badge-primary">${data}</span>`;
            }
            data = Object.keys(data).map(key => {
                return `<span class="badge badge-info">${key.toUpperCase()}</span>${dataToList(data[key])}`
            })
        }
        return data.reduce((prevVal, nextVal, index) => {
            return `
                ${prevVal}
                ${wrappers.prefix}
                ${dataToList(nextVal)}
                ${wrappers.suffix}
            `;
        }, '<ul class="list-group">') + '</ul>';
    }
    function printOut(data = []) {
        const output = document.getElementById('output');
        output.innerHTML = dataToList(data);
    }

    function setSubmit(editor) {
        editor.setValue(`ask {
    let arr = [];
    for (let i = 0; i < names:length; i = i + 1) {
      arr = arr:set(i, { name: names:at(i), power: powers:at(i)});
    }
    arr
}`);
        const button = document.getElementById('submitButton');
        button.addEventListener('click', () => submit(editor));
    }

    function submit(editor) {
        const askCode = editor.getValue();
        const output = document.getElementById('output');
        fetch('http://localhost:8080/ask', {
            method: 'post',
            body: JSON.stringify({code: askCode}),
            headers: {
                'Content-Type': 'application/json'
            }
        }).then(function (response) {
            return response.json();
        }).then(function (data) {
            if (!Array.isArray(data)) {
                output.innerText = JSON.stringify(data);
                return;
            }
            printOut(data);
        });
    }
</script>
</body>
</html>